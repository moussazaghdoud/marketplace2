<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Rainbow Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://js.stripe.com/v3/"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        rainbow: {
                            50: '#eef1fe',
                            100: '#d9dffe',
                            200: '#b8c3fd',
                            300: '#8da0fb',
                            400: '#6e83f8',
                            500: '#4F6DF5',
                            600: '#3a54e0',
                            700: '#2d42b8',
                            800: '#243591',
                            900: '#1e2d76',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .sidebar-link {
            transition: all 0.15s ease;
        }
        .sidebar-link:hover {
            background-color: rgba(79, 109, 245, 0.08);
        }
        .sidebar-link.active {
            background-color: rgba(79, 109, 245, 0.1);
            color: #4F6DF5;
            font-weight: 600;
        }
        .sidebar-link.active .sidebar-icon {
            color: #4F6DF5;
        }
        .fade-in {
            animation: fadeIn 0.25s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(6px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-backdrop {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        .input-focus:focus {
            border-color: #4F6DF5;
            box-shadow: 0 0 0 3px rgba(79, 109, 245, 0.15);
        }
        .stripe-element {
            padding: 10px 14px;
            border: 1px solid #D1D5DB;
            border-radius: 0.5rem;
            transition: border-color 0.15s, box-shadow 0.15s;
        }
        .stripe-element--focus {
            border-color: #4F6DF5;
            box-shadow: 0 0 0 3px rgba(79, 109, 245, 0.15);
        }
        /* Hide scrollbar for sidebar on small screens */
        .sidebar-scroll::-webkit-scrollbar { width: 4px; }
        .sidebar-scroll::-webkit-scrollbar-thumb { background: #e5e7eb; border-radius: 4px; }
        .lang-switcher { position: relative; }
        .lang-switcher button { display: flex; align-items: center; gap: 4px; font-size: 0.8125rem; color: #64748b; cursor: pointer; background: none; border: none; padding: 4px 8px; border-radius: 6px; transition: color 0.2s; }
        .lang-switcher button:hover { color: #0f172a; }
        .lang-switcher .lang-dropdown { display: none; position: absolute; top: 100%; right: 0; background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); min-width: 140px; z-index: 200; padding: 4px 0; margin-top: 4px; }
        .lang-switcher.open .lang-dropdown { display: block; }
        .lang-dropdown button { display: block; width: 100%; text-align: left; padding: 8px 14px; font-size: 0.8125rem; color: #374151; border: none; background: none; cursor: pointer; }
        .lang-dropdown button:hover { background: #f1f5f9; }
        .lang-dropdown button.active { color: #4F6DF5; font-weight: 600; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <!-- Mobile menu overlay -->
    <div id="mobile-overlay" class="fixed inset-0 bg-black/40 z-40 hidden lg:hidden" onclick="toggleMobileSidebar()"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed top-0 left-0 h-full w-64 bg-white border-r border-gray-200 z-50 transform -translate-x-full lg:translate-x-0 transition-transform duration-200">
        <!-- Brand -->
        <div class="h-16 flex items-center gap-3 px-5 border-b border-gray-100">
            <img src="/img/rainbow-logo.png" alt="Rainbow" class="w-8 h-8 rounded-lg flex-shrink-0">
            <div>
                <span class="text-lg font-bold text-gray-900">Rainbow</span>
                <p class="text-[10px] text-gray-400 -mt-0.5" data-i18n="portal.myPortal">My Client Portal</p>
            </div>
        </div>

        <!-- Navigation -->
        <nav class="p-3 space-y-1 sidebar-scroll overflow-y-auto" style="height: calc(100% - 4rem - 4rem);">
            <button onclick="navigateTo('dashboard')" data-nav="dashboard" class="sidebar-link active w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm text-gray-700">
                <svg class="sidebar-icon w-5 h-5 text-gray-400" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25"/></svg>
                <span data-i18n="portal.dashboard">Dashboard</span>
            </button>
            <button onclick="navigateTo('subscriptions')" data-nav="subscriptions" class="sidebar-link w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm text-gray-700">
                <svg class="sidebar-icon w-5 h-5 text-gray-400" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 6.375c0 2.278-3.694 4.125-8.25 4.125S3.75 8.653 3.75 6.375m16.5 0c0-2.278-3.694-4.125-8.25-4.125S3.75 4.097 3.75 6.375m16.5 0v11.25c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125V6.375m16.5 0v3.75m-16.5-3.75v3.75m16.5 0v3.75C20.25 16.153 16.556 18 12 18s-8.25-1.847-8.25-4.125v-3.75m16.5 0c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125"/></svg>
                <span data-i18n="portal.subscriptions">My Subscriptions</span>
            </button>
            <button onclick="navigateTo('profile')" data-nav="profile" class="sidebar-link w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm text-gray-700">
                <svg class="sidebar-icon w-5 h-5 text-gray-400" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z"/></svg>
                <span data-i18n="portal.myInfo">My Information</span>
            </button>
            <button onclick="navigateTo('password')" data-nav="password" class="sidebar-link w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm text-gray-700">
                <svg class="sidebar-icon w-5 h-5 text-gray-400" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z"/></svg>
                <span data-i18n="portal.changePassword">Change Password</span>
            </button>
            <button onclick="navigateTo('payment')" data-nav="payment" class="sidebar-link w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm text-gray-700">
                <svg class="sidebar-icon w-5 h-5 text-gray-400" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h3m-3.75 3h15a2.25 2.25 0 002.25-2.25V6.75A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25v10.5A2.25 2.25 0 004.5 19.5z"/></svg>
                <span data-i18n="portal.paymentMethods">Payment Methods</span>
            </button>
            <button onclick="navigateTo('invoices')" data-nav="invoices" class="sidebar-link w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm text-gray-700">
                <svg class="sidebar-icon w-5 h-5 text-gray-400" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"/></svg>
                <span data-i18n="portal.invoices">Invoices</span>
            </button>
        </nav>

        <!-- User info at bottom -->
        <div class="absolute bottom-0 left-0 right-0 h-16 border-t border-gray-100 flex items-center px-4 bg-white">
            <div class="w-8 h-8 bg-rainbow-100 rounded-full flex items-center justify-center text-rainbow-600 font-semibold text-xs mr-3" id="sidebar-avatar">--</div>
            <div class="flex-1 min-w-0">
                <p class="text-sm font-medium text-gray-800 truncate" id="sidebar-username" data-i18n="portal.loading">Loading...</p>
                <p class="text-xs text-gray-400 truncate" id="sidebar-email">...</p>
            </div>
        </div>
    </aside>

    <!-- Main content area -->
    <div class="lg:ml-64 min-h-screen">
        <!-- Header -->
        <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-4 sm:px-6 sticky top-0 z-30">
            <div class="flex items-center gap-3">
                <button onclick="toggleMobileSidebar()" class="lg:hidden p-2 -ml-2 text-gray-500 hover:text-gray-700 rounded-lg hover:bg-gray-100">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"/></svg>
                </button>
                <h1 class="text-lg font-semibold text-gray-900" id="page-title">Dashboard</h1>
            </div>
            <div class="flex items-center gap-3">
                <span class="hidden sm:block text-sm text-gray-500" id="header-name"></span>
                <button onclick="logout()" class="flex items-center gap-2 px-3 py-2 text-sm text-gray-600 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9"/></svg>
                    <span data-i18n="portal.logout">Log out</span>
                </button>
            </div>
        </header>

        <!-- Page content -->
        <main class="p-4 sm:p-6 lg:p-8" id="main-content">
            <!-- Content dynamically injected here -->
        </main>
    </div>

    <!-- ============================================= -->
    <!-- Modals -->
    <!-- ============================================= -->

    <!-- Change Plan Modal -->
    <div id="modal-change-plan" class="fixed inset-0 z-50 hidden">
        <div class="modal-backdrop absolute inset-0" onclick="closeModal('modal-change-plan')"></div>
        <div class="relative z-10 flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-2xl shadow-xl max-w-lg w-full max-h-[80vh] overflow-y-auto">
                <div class="p-6 border-b border-gray-100 flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-900" data-i18n="portal.changePlanTitle">Change Plan</h3>
                    <button onclick="closeModal('modal-change-plan')" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                </div>
                <div class="p-6" id="change-plan-content">
                    <div class="text-center py-8 text-gray-400">Loading plans...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Subscription Modal -->
    <div id="modal-new-sub" class="fixed inset-0 z-50 hidden">
        <div class="modal-backdrop absolute inset-0" onclick="closeModal('modal-new-sub')"></div>
        <div class="relative z-10 flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-2xl shadow-xl max-w-2xl w-full max-h-[85vh] overflow-y-auto">
                <div class="p-6 border-b border-gray-100 flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-900" data-i18n="portal.newSubscriptionTitle">New Subscription</h3>
                    <button onclick="closeModal('modal-new-sub')" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                </div>
                <div class="p-6" id="new-sub-content">
                    <div class="text-center py-8 text-gray-400">Loading plans...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="modal-payment" class="fixed inset-0 z-50 hidden">
        <div class="modal-backdrop absolute inset-0" onclick="closeModal('modal-payment')"></div>
        <div class="relative z-10 flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-2xl shadow-xl max-w-md w-full">
                <div class="p-6 border-b border-gray-100 flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-900" data-i18n="portal.completePayment">Complete Payment</h3>
                    <button onclick="closeModal('modal-payment')" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                </div>
                <div class="p-6">
                    <div id="payment-summary" class="mb-5 p-4 bg-gray-50 rounded-lg text-sm text-gray-700"></div>

                    <div id="test-card-banner" class="mb-4 p-3 bg-amber-50 border border-amber-200 rounded-lg flex items-center justify-between">
                        <div class="text-xs text-amber-700">
                            <strong>Test mode</strong> — Use: 4242 4242 4242 4242 / 12/28 / 544
                        </div>
                    </div>

                    <div class="space-y-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1.5" data-i18n="portal.cardNumber">Card number</label>
                            <div id="payment-card-number" class="border border-gray-300 rounded-lg px-4 py-3"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1.5" data-i18n="portal.cardExpiry">Expiry date</label>
                                <div id="payment-card-expiry" class="border border-gray-300 rounded-lg px-4 py-3"></div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1.5" data-i18n="portal.cardCvc">CVC</label>
                                <div id="payment-card-cvc" class="border border-gray-300 rounded-lg px-4 py-3"></div>
                            </div>
                        </div>
                    </div>

                    <label class="flex items-center gap-2 mb-5 cursor-pointer select-none">
                        <input type="checkbox" id="save-card-checkbox" checked class="w-4 h-4 text-rainbow-500 border-gray-300 rounded focus:ring-rainbow-500">
                        <span class="text-sm text-gray-600" data-i18n="portal.keepCard">Keep this card for future payments</span>
                    </label>

                    <div id="payment-errors" class="text-sm text-red-600 mb-4 hidden"></div>
                    <button onclick="handleConfirmPayment()" id="btn-confirm-payment"
                        class="w-full py-2.5 px-4 bg-rainbow-500 hover:bg-rainbow-600 text-white font-semibold rounded-lg text-sm transition-colors disabled:opacity-60 disabled:cursor-not-allowed" data-i18n="portal.payNow">
                        Pay Now
                    </button>
                    <p class="text-center text-xs text-gray-400 mt-3">
                        <svg class="w-3.5 h-3.5 inline -mt-0.5 mr-0.5" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z"/></svg>
                        <span data-i18n="portal.stripeSecure">Secured by Stripe. Your card data never touches our servers.</span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Manage Licenses Modal -->
    <div id="modal-licenses" class="fixed inset-0 z-50 hidden">
        <div class="modal-backdrop absolute inset-0" onclick="closeModal('modal-licenses')"></div>
        <div class="relative z-10 flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-2xl shadow-xl max-w-lg w-full max-h-[85vh] overflow-y-auto">
                <div class="p-6 border-b border-gray-100 flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-900" id="licenses-modal-title">Manage Licenses</h3>
                    <button onclick="closeModal('modal-licenses')" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                </div>
                <div class="p-6" id="licenses-content">
                    <div class="text-center py-8 text-gray-400">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Payment Method Modal -->
    <div id="modal-add-card" class="fixed inset-0 z-50 hidden">
        <div class="modal-backdrop absolute inset-0" onclick="closeModal('modal-add-card')"></div>
        <div class="relative z-10 flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-2xl shadow-xl max-w-md w-full">
                <div class="p-6 border-b border-gray-100 flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-900">Add a Card</h3>
                    <button onclick="closeModal('modal-add-card')" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                </div>
                <div class="p-6">
                    <div id="card-element" class="stripe-element mb-4"></div>
                    <div id="card-errors" class="text-sm text-red-600 mb-4 hidden"></div>
                    <button onclick="handleAddCard()" id="btn-add-card"
                        class="w-full py-2.5 px-4 bg-rainbow-500 hover:bg-rainbow-600 text-white font-semibold rounded-lg text-sm transition-colors disabled:opacity-60 disabled:cursor-not-allowed">
                        Add Card
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Company Prompt Modal -->
    <div id="modal-company" class="fixed inset-0 z-50 hidden">
        <div class="modal-backdrop absolute inset-0" onclick="closeModal('modal-company')"></div>
        <div class="relative z-10 flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-2xl shadow-xl max-w-md w-full">
                <div class="p-6 border-b border-gray-100 flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-900" data-i18n="portal.companyRequired">Company Information</h3>
                    <button onclick="closeModal('modal-company')" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                </div>
                <div class="p-6">
                    <p class="text-sm text-gray-500 mb-5" data-i18n="portal.companyRequiredDesc">Please enter your company name before subscribing.</p>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1.5" data-i18n="portal.company">Company</label>
                        <input type="text" id="company-prompt-input" required placeholder="Acme Corp"
                            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg text-sm text-gray-900 placeholder-gray-400 outline-none focus:border-rainbow-500 focus:ring-1 focus:ring-rainbow-500 transition-all">
                    </div>
                    <button onclick="submitCompanyAndSubscribe()" id="btn-company-submit"
                        class="w-full py-2.5 px-4 bg-rainbow-500 hover:bg-rainbow-600 text-white font-semibold rounded-lg text-sm transition-colors disabled:opacity-60 disabled:cursor-not-allowed" data-i18n="portal.continueSubscribe">
                        Continue
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/i18n.js"></script>
    <script>
        function t(k,f){return typeof i18n!=='undefined'?i18n.t(k,f):f;}
        // =============================================
        // Configuration & State
        // =============================================
        const API_BASE = window.location.origin;
        // Rainbow Web URL — matches RAINBOW_DOMAIN in .env
        const RAINBOW_WEB_URL = 'https://web-sandbox.openrainbow.com';
        let token = localStorage.getItem('token');
        let clientData = null;
        let stripe = null;
        let cardElement = null;
        let currentSubscriptionIdForChange = null;
        let cachedPlans = null;

        // =============================================
        // Auth guard
        // =============================================
        if (!token) {
            window.location.href = '/login';
        }

        // =============================================
        // API helper
        // =============================================
        async function api(url, method = 'GET', body = null) {
            const opts = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token,
                },
            };
            if (body) opts.body = JSON.stringify(body);

            const res = await fetch(API_BASE + url, opts);

            if (res.status === 401) {
                localStorage.removeItem('token');
                localStorage.removeItem('client');
                window.location.href = '/login';
                return;
            }

            const data = await res.json().catch(() => ({}));
            if (!res.ok) {
                throw new Error(data.error || data.message || 'An error occurred');
            }
            return data;
        }

        // =============================================
        // Mobile sidebar toggle
        // =============================================
        function toggleMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-overlay');
            sidebar.classList.toggle('-translate-x-full');
            overlay.classList.toggle('hidden');
        }

        // =============================================
        // Navigation
        // =============================================
        const pageTitles = {
            dashboard: 'Dashboard',
            subscriptions: 'My Subscriptions',
            profile: 'My Information',
            password: 'Change Password',
            payment: 'Payment Methods',
            invoices: 'Invoices',
        };

        function navigateTo(page) {
            // Update sidebar active state
            document.querySelectorAll('[data-nav]').forEach(el => {
                el.classList.remove('active');
                if (el.dataset.nav === page) el.classList.add('active');
            });
            // Update title
            document.getElementById('page-title').textContent = t('portal.' + (page === 'profile' ? 'myInfo' : page === 'password' ? 'changePassword' : page === 'payment' ? 'paymentMethods' : page), pageTitles[page] || '');
            // Close mobile sidebar
            const sidebar = document.getElementById('sidebar');
            if (!sidebar.classList.contains('-translate-x-full') && window.innerWidth < 1024) {
                toggleMobileSidebar();
            }
            // Render page
            renderPage(page);
        }

        function renderPage(page) {
            const main = document.getElementById('main-content');
            switch (page) {
                case 'dashboard': renderDashboard(main); break;
                case 'subscriptions': renderSubscriptions(main); break;
                case 'profile': renderProfile(main); break;
                case 'password': renderPassword(main); break;
                case 'payment': renderPayment(main); break;
                case 'invoices': renderInvoices(main); break;
                default: renderDashboard(main);
            }
        }

        // =============================================
        // Logout
        // =============================================
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('client');
            window.location.href = '/login';
        }

        // =============================================
        // Modal helpers
        // =============================================
        function openModal(id) {
            document.getElementById(id).classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
            document.body.style.overflow = '';
        }

        // =============================================
        // Toast notification
        // =============================================
        function showToast(message, type = 'success') {
            const existing = document.getElementById('toast');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.id = 'toast';
            toast.className = `fixed top-20 right-4 z-[60] px-4 py-3 rounded-lg shadow-lg text-sm font-medium transition-all transform translate-x-0 ${
                type === 'success' ? 'bg-green-600 text-white' :
                type === 'error' ? 'bg-red-600 text-white' :
                'bg-blue-600 text-white'
            }`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3500);
        }

        // =============================================
        // Format helpers
        // =============================================
        function formatPrice(cents) {
            return (cents / 100).toFixed(2).replace('.', ',') + ' EUR';
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            return d.toLocaleDateString('en-US', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        function statusBadge(status) {
            const map = {
                active: { label: t('portal.active','Active'), class: 'bg-green-100 text-green-700' },
                trialing: { label: t('portal.trial','Trial'), class: 'bg-blue-100 text-blue-700' },
                past_due: { label: t('portal.overdue','Overdue'), class: 'bg-yellow-100 text-yellow-700' },
                canceled: { label: t('portal.canceled','Canceled'), class: 'bg-gray-100 text-gray-600' },
                unpaid: { label: t('portal.unpaid','Unpaid'), class: 'bg-red-100 text-red-700' },
            };
            const s = map[status] || { label: status, class: 'bg-gray-100 text-gray-600' };
            return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${s.class}">${s.label}</span>`;
        }

        // =============================================
        // PAGE: Dashboard
        // =============================================
        async function renderDashboard(container) {
            container.innerHTML = `
                <div class="fade-in">
                    <div class="mb-8">
                        <h2 class="text-2xl font-bold text-gray-900 mb-1">${t('portal.welcome','Welcome,')} <span id="dash-name" class="text-rainbow-500">...</span></h2>
                        <p class="text-gray-500">${t('portal.dashboardSummary','Here is a summary of your Rainbow account.')}</p>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5" id="dash-cards">
                        <div class="bg-white rounded-xl border border-gray-200 p-5 animate-pulse">
                            <div class="h-4 bg-gray-200 rounded w-1/2 mb-3"></div>
                            <div class="h-8 bg-gray-200 rounded w-1/3"></div>
                        </div>
                        <div class="bg-white rounded-xl border border-gray-200 p-5 animate-pulse">
                            <div class="h-4 bg-gray-200 rounded w-1/2 mb-3"></div>
                            <div class="h-8 bg-gray-200 rounded w-1/3"></div>
                        </div>
                        <div class="bg-white rounded-xl border border-gray-200 p-5 animate-pulse">
                            <div class="h-4 bg-gray-200 rounded w-1/2 mb-3"></div>
                            <div class="h-8 bg-gray-200 rounded w-1/3"></div>
                        </div>
                    </div>
                </div>
            `;

            try {
                if (!clientData) {
                    clientData = await api('/api/client/me');
                }
                document.getElementById('dash-name').textContent = clientData.firstName || clientData.email;

                const subs = await api('/api/client/subscriptions');
                const activeSubs = (subs || []).filter(s => s.status === 'active' || s.status === 'trialing');
                const totalLicenses = activeSubs.reduce((sum, s) => sum + (s.licenseCount || s.quantity || 0), 0);

                document.getElementById('dash-cards').innerHTML = `
                    <div class="bg-white rounded-xl border border-gray-200 p-5 hover:shadow-md transition-shadow">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-10 h-10 bg-rainbow-50 rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 text-rainbow-500" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 6.375c0 2.278-3.694 4.125-8.25 4.125S3.75 8.653 3.75 6.375m16.5 0c0-2.278-3.694-4.125-8.25-4.125S3.75 4.097 3.75 6.375m16.5 0v11.25c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125V6.375"/></svg>
                            </div>
                            <p class="text-sm text-gray-500">${t('portal.activeSubscriptions','Active Subscriptions')}</p>
                        </div>
                        <p class="text-3xl font-bold text-gray-900">${activeSubs.length}</p>
                    </div>
                    <div class="bg-white rounded-xl border border-gray-200 p-5 hover:shadow-md transition-shadow">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-10 h-10 bg-green-50 rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z"/></svg>
                            </div>
                            <p class="text-sm text-gray-500">${t('portal.totalLicenses','Total Licenses')}</p>
                        </div>
                        <p class="text-3xl font-bold text-gray-900">${totalLicenses}</p>
                    </div>
                    <div class="bg-white rounded-xl border border-gray-200 p-5 hover:shadow-md transition-shadow">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-10 h-10 bg-purple-50 rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 text-purple-500" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285z"/></svg>
                            </div>
                            <p class="text-sm text-gray-500">${t('portal.accountStatus','Account Status')}</p>
                        </div>
                        <p class="text-lg font-semibold text-green-600">${activeSubs.length > 0 ? t('portal.active','Active') : t('portal.noSubscription','No Subscription')}</p>
                    </div>
                `;

                // Rainbow access card — always visible
                document.getElementById('dash-cards').insertAdjacentHTML('afterend', `
                    <div class="mt-6 bg-gradient-to-r from-indigo-50 via-blue-50 to-purple-50 rounded-xl border border-indigo-200 p-6 flex flex-col sm:flex-row items-center gap-5">
                        <div class="w-14 h-14 bg-white rounded-xl shadow-sm flex items-center justify-center shrink-0">
                            <img src="/img/rainbow-logo.png" alt="Rainbow" class="w-9 h-9 rounded-lg">
                        </div>
                        <div class="flex-1 text-center sm:text-left">
                            <h3 class="text-base font-bold text-gray-900 mb-1">${t('portal.rainbowAccess','Access Rainbow')}</h3>
                            <p class="text-sm text-gray-500">${t('portal.rainbowAccessDesc','Open the Rainbow communication platform — messaging, video calls, and collaboration.')}</p>
                        </div>
                        <a href="${RAINBOW_WEB_URL}" target="_blank" rel="noopener" class="inline-flex items-center gap-2 px-5 py-2.5 bg-rainbow-500 hover:bg-rainbow-600 text-white text-sm font-semibold rounded-lg transition-colors shrink-0">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25"/></svg>
                            ${t('portal.openRainbow','Open Rainbow')}
                        </a>
                    </div>
                `);

                // Show CTA if no subscriptions
                if (activeSubs.length === 0) {
                    document.getElementById('dash-cards').insertAdjacentHTML('afterend', `
                        <div class="mt-8 bg-gradient-to-r from-rainbow-50 to-white rounded-xl border border-rainbow-200 p-8 text-center">
                            <div class="w-14 h-14 bg-rainbow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg class="w-7 h-7 text-rainbow-500" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"/></svg>
                            </div>
                            <h3 class="text-lg font-bold text-gray-900 mb-2">${t('portal.getStartedTitle','Get Started with Rainbow')}</h3>
                            <p class="text-sm text-gray-500 mb-5 max-w-md mx-auto">${t('portal.getStartedDescription','Choose a plan for your team and start collaborating today.')}</p>
                            <button onclick="navigateTo('subscriptions')" class="inline-flex items-center gap-2 px-6 py-2.5 bg-rainbow-500 hover:bg-rainbow-600 text-white text-sm font-semibold rounded-lg transition-colors">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"/></svg>
                                ${t('portal.choosePlan','Choose a Plan')}
                            </button>
                        </div>
                    `);
                }

                // Show subscription summary below
                if (activeSubs.length > 0) {
                    let summaryHTML = `
                        <div class="mt-8">
                            <h3 class="text-base font-semibold text-gray-900 mb-4">${t('portal.subscriptionSummary','Subscription Summary')}</h3>
                            <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                                <table class="w-full text-sm">
                                    <thead class="bg-gray-50 text-gray-500">
                                        <tr>
                                            <th class="text-left py-3 px-4 font-medium">${t('portal.plan','Plan')}</th>
                                            <th class="text-left py-3 px-4 font-medium">${t('portal.licenses','Licenses')}</th>
                                            <th class="text-left py-3 px-4 font-medium">${t('portal.status','Status')}</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-100">
                    `;
                    activeSubs.forEach(sub => {
                        summaryHTML += `
                            <tr>
                                <td class="py-3 px-4 font-medium text-gray-900">${sub.planName || sub.plan || '-'}</td>
                                <td class="py-3 px-4 text-gray-600">${sub.licenseCount || sub.quantity || '-'}</td>
                                <td class="py-3 px-4">${statusBadge(sub.status)}</td>
                            </tr>
                        `;
                    });
                    summaryHTML += `</tbody></table></div></div>`;
                    document.getElementById('dash-cards').insertAdjacentHTML('afterend', summaryHTML);
                }

            } catch (err) {
                console.error('Dashboard error:', err);
            }
        }

        // =============================================
        // PAGE: Subscriptions
        // =============================================
        async function renderSubscriptions(container) {
            container.innerHTML = `
                <div class="fade-in">
                    <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-6 gap-3">
                        <div>
                            <h2 class="text-xl font-bold text-gray-900">${t('portal.subscriptions','My Subscriptions')}</h2>
                            <p class="text-sm text-gray-500 mt-0.5">${t('portal.manageSubscriptions','Manage your Rainbow subscriptions')}</p>
                        </div>
                        <button onclick="openNewSubscriptionModal()" class="inline-flex items-center gap-2 px-4 py-2.5 bg-rainbow-500 hover:bg-rainbow-600 text-white text-sm font-semibold rounded-lg transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"/></svg>
                            ${t('portal.newSubscription','New Subscription')}
                        </button>
                    </div>
                    <div id="subs-list" class="space-y-4">
                        <div class="bg-white rounded-xl border border-gray-200 p-6 animate-pulse">
                            <div class="h-5 bg-gray-200 rounded w-1/3 mb-3"></div>
                            <div class="h-4 bg-gray-200 rounded w-1/2"></div>
                        </div>
                    </div>
                </div>
            `;

            try {
                const subs = await api('/api/client/subscriptions');
                const listEl = document.getElementById('subs-list');

                if (!subs || subs.length === 0) {
                    listEl.innerHTML = `
                        <div class="bg-white rounded-xl border border-gray-200 p-12 text-center">
                            <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 6.375c0 2.278-3.694 4.125-8.25 4.125S3.75 8.653 3.75 6.375m16.5 0c0-2.278-3.694-4.125-8.25-4.125S3.75 4.097 3.75 6.375m16.5 0v11.25c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125V6.375"/></svg>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-1">${t('portal.noSubscriptions','No Subscriptions')}</h3>
                            <p class="text-gray-500 text-sm mb-4">${t('portal.noSubscriptionsDesc','You don\'t have any active subscriptions yet.')}</p>
                            <button onclick="openNewSubscriptionModal()" class="inline-flex items-center gap-2 px-4 py-2 bg-rainbow-500 hover:bg-rainbow-600 text-white text-sm font-semibold rounded-lg transition-colors">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"/></svg>
                                ${t('portal.subscribeNow','Subscribe Now')}
                            </button>
                        </div>
                    `;
                    return;
                }

                listEl.innerHTML = subs.map(sub => `
                    <div class="bg-white rounded-xl border border-gray-200 p-5 hover:shadow-md transition-shadow">
                        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-2">
                                    <h3 class="text-base font-semibold text-gray-900">${sub.planName || sub.plan || 'Plan Rainbow'}</h3>
                                    ${statusBadge(sub.status)}
                                </div>
                                <div class="flex flex-wrap gap-x-6 gap-y-1 text-sm text-gray-500">
                                    <span>${t('portal.licensesLabel','Licenses:')} <strong class="text-gray-700">${sub.licenseCount || sub.quantity || '-'}</strong></span>
                                    <span>${t('portal.priceLabel','Price:')} <strong class="text-gray-700">${sub.price ? formatPrice(sub.price) : '-'}</strong></span>
                                    ${sub.currentPeriodEnd ? `<span>${t('portal.renewalLabel','Renewal:')} <strong class="text-gray-700">${formatDate(sub.currentPeriodEnd)}</strong></span>` : ''}
                                </div>
                            </div>
                            <div class="flex items-center gap-2 flex-wrap">
                                ${sub.status !== 'canceled' && sub.status !== 'cancelling' ? `
                                    ${sub.status === 'pending' ? `
                                        <button onclick="retryPayment('${sub.id}')" class="px-4 py-2 text-sm font-semibold text-white bg-green-500 hover:bg-green-600 rounded-lg transition-colors shadow-sm">
                                            <svg class="w-4 h-4 inline -mt-0.5 mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 00-3 3h15.75m-12.75-3h11.218c1.121-2.3 2.1-4.684 2.924-7.138a60.114 60.114 0 00-16.536-1.84M7.5 14.25L5.106 5.272M6 20.25a.75.75 0 11-1.5 0 .75.75 0 011.5 0zm12.75 0a.75.75 0 11-1.5 0 .75.75 0 011.5 0z"/></svg>
                                            ${t('portal.buy','Buy')}
                                        </button>
                                    ` : ''}
                                    <button onclick="openManageLicensesModal('${sub.id}', ${sub.licenseCount || 0})" class="px-3 py-2 text-sm font-medium text-green-700 hover:bg-green-50 border border-green-200 rounded-lg transition-colors">
                                        <svg class="w-4 h-4 inline -mt-0.5 mr-1" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z"/></svg>
                                        Manage Licenses
                                    </button>
                                    <button onclick="openChangePlanModal('${sub.id}')" class="px-3 py-2 text-sm font-medium text-rainbow-600 hover:bg-rainbow-50 border border-rainbow-200 rounded-lg transition-colors">
                                        ${t('portal.changePlan','Change Plan')}
                                    </button>
                                    <button onclick="cancelSubscription('${sub.id}')" class="px-3 py-2 text-sm font-medium text-red-600 hover:bg-red-50 border border-red-200 rounded-lg transition-colors">
                                        ${t('portal.cancel','Cancel')}
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `).join('');

            } catch (err) {
                document.getElementById('subs-list').innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-xl p-4 text-sm text-red-700">Error: ${err.message}</div>
                `;
            }
        }

        // =============================================
        // Change plan modal
        // =============================================
        async function openChangePlanModal(subscriptionId) {
            currentSubscriptionIdForChange = subscriptionId;
            openModal('modal-change-plan');
            const content = document.getElementById('change-plan-content');
            content.innerHTML = '<div class="text-center py-8 text-gray-400">' + t('portal.loadingPlans','Loading plans...') + '</div>';

            try {
                const plans = await fetchPlans();
                if (!plans || plans.length === 0) {
                    content.innerHTML = '<div class="text-center py-8 text-gray-500">' + t('portal.noPlans','No plans available.') + '</div>';
                    return;
                }

                content.innerHTML = `
                    <div class="space-y-3">
                        ${plans.map(plan => `
                            <button onclick="changePlan('${subscriptionId}', '${plan.id}')"
                                class="w-full text-left p-4 border border-gray-200 rounded-lg hover:border-rainbow-300 hover:bg-rainbow-50/50 transition-all">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="font-semibold text-gray-900">${plan.name}</p>
                                        <p class="text-sm text-gray-500 mt-0.5">${plan.description || ''}</p>
                                    </div>
                                    <span class="text-rainbow-600 font-bold">${plan.pricePerUser != null ? (plan.pricePerUser === 0 ? (plan.price || t('portal.free','Free')) : plan.pricePerUser.toFixed(2).replace('.', ',') + ' EUR') : (plan.price || '-')}<span class="text-xs font-normal text-gray-400">/mo</span></span>
                                </div>
                            </button>
                        `).join('')}
                    </div>
                `;
            } catch (err) {
                content.innerHTML = `<div class="text-red-600 text-sm">${err.message}</div>`;
            }
        }

        async function changePlan(subscriptionId, planId) {
            if (!confirm('Confirm plan change?')) return;
            try {
                await api(`/api/client/subscriptions/${subscriptionId}`, 'PUT', { planId });
                closeModal('modal-change-plan');
                showToast(t('portal.planChanged','Plan changed successfully'));
                navigateTo('subscriptions');
            } catch (err) {
                showToast(err.message, 'error');
            }
        }

        // =============================================
        // New subscription modal
        // =============================================
        async function openNewSubscriptionModal(preselectedPlan, preselectedLicenses) {
            openModal('modal-new-sub');
            const content = document.getElementById('new-sub-content');
            content.innerHTML = '<div class="text-center py-8 text-gray-400">' + t('portal.loadingPlans','Loading plans...') + '</div>';

            try {
                const plans = await fetchPlans();
                if (!plans || plans.length === 0) {
                    content.innerHTML = '<div class="text-center py-8 text-gray-500">' + t('portal.noPlans','No plans available.') + '</div>';
                    return;
                }

                // Find pre-selected plan by matching name/key
                let defaultIndex = 0;
                let defaultPlanId = plans[0]?.id || '';
                if (preselectedPlan) {
                    const match = plans.findIndex(p =>
                        p.name.toLowerCase().replace(/\s+/g, '-') === preselectedPlan.toLowerCase() ||
                        p.name.toLowerCase() === preselectedPlan.toLowerCase() ||
                        (p.id && p.id === preselectedPlan)
                    );
                    if (match >= 0) {
                        defaultIndex = match;
                        defaultPlanId = plans[match].id;
                    }
                }

                const licenseValue = parseInt(preselectedLicenses) || 1;

                content.innerHTML = `
                    <p class="text-sm text-gray-500 mb-4">${t('portal.newSubscriptionDesc','Select a plan and the number of licenses you need.')}</p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-6" id="plan-cards">
                        ${plans.map((plan, i) => `
                            <button onclick="selectPlan(this, '${plan.id}')"
                                data-plan-id="${plan.id}"
                                class="plan-card text-left p-4 border-2 ${i === defaultIndex ? 'border-rainbow-500 bg-rainbow-50/30' : 'border-gray-200'} rounded-xl hover:border-rainbow-400 transition-all">
                                <p class="font-semibold text-gray-900 text-sm">${plan.name}</p>
                                <p class="text-xs text-gray-500 mt-1 mb-3">${plan.description || ''}</p>
                                <p class="text-lg font-bold text-rainbow-600">${plan.pricePerUser != null ? (plan.pricePerUser === 0 ? (plan.price || t('portal.free','Free')) : plan.pricePerUser.toFixed(2).replace('.', ',') + ' EUR') : (plan.price || '-')}<span class="text-xs font-normal text-gray-400">/mo/license</span></p>
                            </button>
                        `).join('')}
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-1.5">${t('portal.numLicenses','Number of licenses')}</label>
                        <input type="number" id="new-sub-licenses" min="1" value="${licenseValue}"
                            class="input-focus w-full px-4 py-2.5 border border-gray-300 rounded-lg text-sm text-gray-900 outline-none transition-all">
                    </div>
                    <input type="hidden" id="selected-plan-id" value="${defaultPlanId}">
                    <button onclick="createSubscription()" id="btn-create-sub"
                        class="w-full py-2.5 px-4 bg-rainbow-500 hover:bg-rainbow-600 text-white font-semibold rounded-lg text-sm transition-colors disabled:opacity-60 disabled:cursor-not-allowed">
                        ${t('portal.subscribe','Subscribe')}
                    </button>
                `;
            } catch (err) {
                content.innerHTML = `<div class="text-red-600 text-sm">${err.message}</div>`;
            }
        }

        function selectPlan(el, planId) {
            document.querySelectorAll('.plan-card').forEach(c => {
                c.classList.remove('border-rainbow-500', 'bg-rainbow-50/30');
                c.classList.add('border-gray-200');
            });
            el.classList.remove('border-gray-200');
            el.classList.add('border-rainbow-500', 'bg-rainbow-50/30');
            document.getElementById('selected-plan-id').value = planId;
        }

        // Pending subscription params when waiting for company info
        let _pendingSubPlanId = null;
        let _pendingSubLicenseCount = null;

        async function createSubscription() {
            const planId = document.getElementById('selected-plan-id').value;
            const licenseCount = parseInt(document.getElementById('new-sub-licenses').value) || 1;

            // Check if user has company info
            if (!clientData) clientData = await api('/api/client/me');
            if (!clientData.company || !clientData.company.trim()) {
                // Store pending subscription params and show company prompt
                _pendingSubPlanId = planId;
                _pendingSubLicenseCount = licenseCount;
                closeModal('modal-new-sub');
                openModal('modal-company');
                document.getElementById('company-prompt-input').focus();
                return;
            }

            await doCreateSubscription(planId, licenseCount);
        }

        async function submitCompanyAndSubscribe() {
            const companyName = document.getElementById('company-prompt-input').value.trim();
            if (!companyName) {
                showToast(t('portal.companyNameRequired','Please enter a company name.'), 'error');
                return;
            }

            const btn = document.getElementById('btn-company-submit');
            btn.disabled = true;
            btn.textContent = t('portal.saving','Saving...');

            try {
                // Save company name
                await api('/api/client/me', 'PUT', {
                    firstName: clientData.firstName,
                    lastName: clientData.lastName,
                    company: companyName
                });
                clientData.company = companyName;

                closeModal('modal-company');

                // Now create the subscription
                if (_pendingSubPlanId) {
                    await doCreateSubscription(_pendingSubPlanId, _pendingSubLicenseCount);
                    _pendingSubPlanId = null;
                    _pendingSubLicenseCount = null;
                }
            } catch (err) {
                showToast(err.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = t('portal.continueSubscribe','Continue');
            }
        }

        async function doCreateSubscription(planId, licenseCount) {
            const btn = document.getElementById('btn-create-sub');
            if (btn) { btn.disabled = true; btn.textContent = 'Processing...'; }

            try {
                const result = await api('/api/client/subscriptions', 'POST', { planId, licenseCount });
                closeModal('modal-new-sub');
                showToast(t('portal.subscriptionCreated','Subscription created successfully!'));
                navigateTo('subscriptions');
            } catch (err) {
                showToast(err.message, 'error');
            } finally {
                if (btn) { btn.disabled = false; btn.textContent = t('portal.subscribe','Subscribe'); }
            }
        }

        // =============================================
        // Payment confirmation (Stripe card payment)
        // =============================================
        let paymentCardNumber = null;
        let paymentCardExpiry = null;
        let paymentCardCvc = null;
        let paymentStripeInstance = null;

        const stripeElementStyle = {
            base: {
                fontSize: '14px',
                color: '#1F2937',
                fontFamily: 'Inter, sans-serif',
                '::placeholder': { color: '#9CA3AF' },
            },
            invalid: { color: '#EF4444' },
        };

        async function openPaymentModal(clientSecret, publishableKey, planName, planPrice, subscriptionId) {
            openModal('modal-payment');
            document.getElementById('payment-errors').classList.add('hidden');
            document.getElementById('payment-summary').innerHTML =
                `<strong>${planName}</strong>` + (planPrice ? ` &mdash; ${planPrice}` : '');
            window._paymentSubscriptionId = subscriptionId || null;

            if (!paymentStripeInstance) {
                paymentStripeInstance = Stripe(publishableKey || stripe?._apiKey);
            }

            // Unmount previous elements
            if (paymentCardNumber) { paymentCardNumber.unmount(); paymentCardNumber = null; }
            if (paymentCardExpiry) { paymentCardExpiry.unmount(); paymentCardExpiry = null; }
            if (paymentCardCvc) { paymentCardCvc.unmount(); paymentCardCvc = null; }

            const elements = paymentStripeInstance.elements();
            paymentCardNumber = elements.create('cardNumber', { style: stripeElementStyle });
            paymentCardExpiry = elements.create('cardExpiry', { style: stripeElementStyle });
            paymentCardCvc = elements.create('cardCvc', { style: stripeElementStyle });

            paymentCardNumber.mount('#payment-card-number');
            paymentCardExpiry.mount('#payment-card-expiry');
            paymentCardCvc.mount('#payment-card-cvc');

            window._paymentClientSecret = clientSecret;
        }

        async function handleConfirmPayment() {
            const btn = document.getElementById('btn-confirm-payment');
            btn.disabled = true;
            btn.textContent = t('portal.processing','Processing...');
            document.getElementById('payment-errors').classList.add('hidden');

            const saveCard = document.getElementById('save-card-checkbox').checked;

            try {
                const paymentOpts = {
                    payment_method: { card: paymentCardNumber }
                };
                if (saveCard) {
                    paymentOpts.setup_future_usage = 'off_session';
                }

                const { error, paymentIntent } = await paymentStripeInstance.confirmCardPayment(
                    window._paymentClientSecret,
                    paymentOpts
                );

                if (error) {
                    throw new Error(error.message);
                }

                // If save card is checked, attach the payment method to the customer
                if (saveCard && paymentIntent.payment_method) {
                    api('/api/client/payment-methods/save', 'POST', {
                        paymentMethodId: paymentIntent.payment_method
                    }).catch(() => {}); // fire-and-forget
                }

                // Confirm payment on server — update subscription status to active
                if (window._paymentSubscriptionId) {
                    await api(`/api/client/subscriptions/${window._paymentSubscriptionId}/confirm-payment`, 'POST')
                        .catch(() => {}); // also handled by webhook as fallback
                }

                closeModal('modal-payment');
                showToast(t('portal.paymentSuccess','Payment successful! Subscription is now active.'));
                navigateTo('subscriptions');
            } catch (err) {
                const errEl = document.getElementById('payment-errors');
                errEl.textContent = err.message;
                errEl.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.textContent = t('portal.payNow','Pay Now');
            }
        }

        // =============================================
        // Retry payment for pending subscription
        // =============================================
        async function retryPayment(subscriptionId) {
            try {
                const result = await api(`/api/client/subscriptions/${subscriptionId}/retry-payment`, 'POST');
                if (result.status === 'active') {
                    showToast('Subscription is now active!');
                    navigateTo('subscriptions');
                    return;
                }
                if (result.clientSecret) {
                    await openPaymentModal(result.clientSecret, result.publishableKey, result.planName || 'Subscription', '', subscriptionId);
                } else {
                    showToast('Unable to process payment. Please contact support.', 'error');
                }
            } catch (err) {
                showToast(err.message, 'error');
            }
        }

        // =============================================
        // Cancel subscription
        // =============================================
        async function cancelSubscription(subscriptionId) {
            if (!confirm('Are you sure you want to cancel this subscription? This will take effect at the end of the current billing period.')) return;
            try {
                await api(`/api/client/subscriptions/${subscriptionId}/cancel`, 'POST');
                showToast(t('portal.subscriptionCanceled','Subscription canceled.'));
                navigateTo('subscriptions');
            } catch (err) {
                showToast(err.message, 'error');
            }
        }

        // =============================================
        // Manage Licenses
        // =============================================
        let currentLicenseSubId = null;

        async function openManageLicensesModal(subscriptionId, totalLicenses) {
            currentLicenseSubId = subscriptionId;
            openModal('modal-licenses');
            const content = document.getElementById('licenses-content');
            content.innerHTML = '<div class="text-center py-8 text-gray-400">Loading licenses...</div>';

            try {
                const data = await api(`/api/client/subscriptions/${subscriptionId}/licenses`);
                const assignments = data.assignments || [];
                const licenseCount = data.licenseCount || totalLicenses;
                const activeAssignments = assignments.filter(a => a.status !== 'revoked');
                const assignedCount = activeAssignments.length;

                document.getElementById('licenses-modal-title').textContent =
                    `Manage Licenses (${assignedCount}/${licenseCount} assigned)`;

                let html = '';

                // Invite form
                if (assignedCount < licenseCount) {
                    html += `
                        <div class="mb-5 p-4 bg-gray-50 rounded-lg">
                            <label class="block text-sm font-medium text-gray-700 mb-1.5">Invite an employee</label>
                            <div class="flex gap-2">
                                <input type="email" id="license-invite-email" placeholder="employee@company.com"
                                    class="input-focus flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm text-gray-900 outline-none transition-all">
                                <button onclick="sendLicenseInvite('${subscriptionId}')" id="btn-send-invite"
                                    class="px-4 py-2 bg-rainbow-500 hover:bg-rainbow-600 text-white text-sm font-semibold rounded-lg transition-colors whitespace-nowrap">
                                    Send Invite
                                </button>
                            </div>
                            <div id="invite-error" class="text-sm text-red-600 mt-2 hidden"></div>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="mb-5 p-4 bg-yellow-50 border border-yellow-200 rounded-lg text-sm text-yellow-700">
                            All licenses are assigned. Revoke one to invite a new employee, or upgrade your plan.
                        </div>
                    `;
                }

                // List of assignments
                if (activeAssignments.length === 0) {
                    html += `
                        <div class="text-center py-6 text-gray-400 text-sm">
                            No licenses assigned yet. Invite employees above.
                        </div>
                    `;
                } else {
                    html += '<div class="space-y-2">';
                    activeAssignments.forEach(a => {
                        const statusClass = a.status === 'accepted'
                            ? 'bg-green-100 text-green-700'
                            : 'bg-yellow-100 text-yellow-700';
                        const statusLabel = a.status === 'accepted' ? 'Accepted' : 'Pending';
                        html += `
                            <div class="flex items-center justify-between p-3 bg-white border border-gray-200 rounded-lg">
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-medium text-gray-900 truncate">${a.email}</p>
                                    <p class="text-xs text-gray-400">Invited ${formatDate(a.invitedAt)}</p>
                                </div>
                                <div class="flex items-center gap-2 ml-3">
                                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${statusClass}">${statusLabel}</span>
                                    <button onclick="revokeLicense('${subscriptionId}', '${a.id}')"
                                        class="px-2 py-1 text-xs font-medium text-red-600 hover:bg-red-50 border border-red-200 rounded transition-colors">
                                        Revoke
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                }

                content.innerHTML = html;
            } catch (err) {
                content.innerHTML = `<div class="text-red-600 text-sm">${err.message}</div>`;
            }
        }

        async function sendLicenseInvite(subscriptionId) {
            const emailInput = document.getElementById('license-invite-email');
            const email = emailInput.value.trim();
            const errEl = document.getElementById('invite-error');
            errEl.classList.add('hidden');

            if (!email) {
                errEl.textContent = 'Please enter an email address.';
                errEl.classList.remove('hidden');
                return;
            }

            const btn = document.getElementById('btn-send-invite');
            btn.disabled = true;
            btn.textContent = 'Sending...';

            try {
                await api(`/api/client/subscriptions/${subscriptionId}/licenses`, 'POST', { email });
                showToast('Invite sent to ' + email);
                // Refresh the modal
                await openManageLicensesModal(subscriptionId);
            } catch (err) {
                errEl.textContent = err.message;
                errEl.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Send Invite';
            }
        }

        async function revokeLicense(subscriptionId, assignmentId) {
            if (!confirm('Revoke this license? The employee will lose access.')) return;
            try {
                await api(`/api/client/subscriptions/${subscriptionId}/licenses/${assignmentId}`, 'DELETE');
                showToast('License revoked');
                await openManageLicensesModal(subscriptionId);
            } catch (err) {
                showToast(err.message, 'error');
            }
        }

        // =============================================
        // Fetch plans
        // =============================================
        async function fetchPlans() {
            if (cachedPlans) return cachedPlans;
            const data = await api('/api/products/rainbow');
            let plans = data.plans || data || [];
            if (plans && !Array.isArray(plans)) {
                plans = Object.entries(plans).map(([key, val]) => ({ id: key, ...val }));
            }
            cachedPlans = plans;
            return cachedPlans;
        }

        // =============================================
        // PAGE: Profile
        // =============================================
        async function renderProfile(container) {
            container.innerHTML = `
                <div class="fade-in">
                    <div class="mb-6">
                        <h2 class="text-xl font-bold text-gray-900">${t('portal.myInfoTitle','My Information')}</h2>
                        <p class="text-sm text-gray-500 mt-0.5">${t('portal.myInfoDesc','Update your personal and professional information')}</p>
                    </div>
                    <div class="bg-white rounded-xl border border-gray-200 p-6" id="profile-form-container">
                        <div class="animate-pulse space-y-4">
                            <div class="h-4 bg-gray-200 rounded w-1/3"></div>
                            <div class="h-10 bg-gray-200 rounded"></div>
                            <div class="h-4 bg-gray-200 rounded w-1/3"></div>
                            <div class="h-10 bg-gray-200 rounded"></div>
                        </div>
                    </div>
                </div>
            `;

            try {
                const profile = await api('/api/client/me');
                clientData = profile;
                const fc = document.getElementById('profile-form-container');

                fc.innerHTML = `
                    <form onsubmit="handleSaveProfile(event)" class="space-y-5">
                        <div id="profile-msg" class="hidden p-3 rounded-lg text-sm font-medium mb-2"></div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1.5">${t('portal.firstName','First name')}</label>
                                <input type="text" id="prof-firstName" value="${profile.firstName || ''}"
                                    class="input-focus w-full px-4 py-2.5 border border-gray-300 rounded-lg text-sm text-gray-900 outline-none transition-all">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1.5">${t('portal.lastName','Last name')}</label>
                                <input type="text" id="prof-lastName" value="${profile.lastName || ''}"
                                    class="input-focus w-full px-4 py-2.5 border border-gray-300 rounded-lg text-sm text-gray-900 outline-none transition-all">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1.5">${t('portal.company','Company')}</label>
                            <input type="text" id="prof-company" value="${profile.company || ''}"
                                class="input-focus w-full px-4 py-2.5 border border-gray-300 rounded-lg text-sm text-gray-900 outline-none transition-all">
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1.5">${t('portal.companySize','Company size')}</label>
                                <select id="prof-companySize"
                                    class="input-focus w-full px-4 py-2.5 border border-gray-300 rounded-lg text-sm text-gray-900 outline-none transition-all bg-white">
                                    <option value="">Select</option>
                                    <option value="1-10" ${profile.companySize === '1-10' ? 'selected' : ''}>1-10 employees</option>
                                    <option value="11-50" ${profile.companySize === '11-50' ? 'selected' : ''}>11-50 employees</option>
                                    <option value="51-200" ${profile.companySize === '51-200' ? 'selected' : ''}>51-200 employees</option>
                                    <option value="201-500" ${profile.companySize === '201-500' ? 'selected' : ''}>201-500 employees</option>
                                    <option value="501+" ${profile.companySize === '501+' ? 'selected' : ''}>501+ employees</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1.5">${t('portal.phone','Phone')}</label>
                                <input type="tel" id="prof-phone" value="${profile.phone || ''}"
                                    class="input-focus w-full px-4 py-2.5 border border-gray-300 rounded-lg text-sm text-gray-900 outline-none transition-all">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1.5">${t('portal.address','Address')}</label>
                            <input type="text" id="prof-address" value="${profile.address || ''}"
                                class="input-focus w-full px-4 py-2.5 border border-gray-300 rounded-lg text-sm text-gray-900 outline-none transition-all">
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-5">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1.5">${t('portal.city','City')}</label>
                                <input type="text" id="prof-city" value="${profile.city || ''}"
                                    class="input-focus w-full px-4 py-2.5 border border-gray-300 rounded-lg text-sm text-gray-900 outline-none transition-all">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1.5">${t('portal.postalCode','Postal code')}</label>
                                <input type="text" id="prof-postalCode" value="${profile.postalCode || ''}"
                                    class="input-focus w-full px-4 py-2.5 border border-gray-300 rounded-lg text-sm text-gray-900 outline-none transition-all">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1.5">${t('portal.country','Country')}</label>
                                <input type="text" id="prof-country" value="${profile.country || ''}"
                                    class="input-focus w-full px-4 py-2.5 border border-gray-300 rounded-lg text-sm text-gray-900 outline-none transition-all">
                            </div>
                        </div>
                        <div class="pt-2">
                            <button type="submit" id="btn-save-profile"
                                class="px-6 py-2.5 bg-rainbow-500 hover:bg-rainbow-600 text-white font-semibold rounded-lg text-sm transition-colors disabled:opacity-60 disabled:cursor-not-allowed">
                                ${t('portal.saveChanges','Save Changes')}
                            </button>
                        </div>
                    </form>
                `;
            } catch (err) {
                document.getElementById('profile-form-container').innerHTML = `
                    <div class="text-red-600 text-sm">${err.message}</div>
                `;
            }
        }

        async function handleSaveProfile(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-save-profile');
            btn.disabled = true;
            btn.textContent = t('portal.saving','Saving...');

            try {
                const body = {
                    firstName: document.getElementById('prof-firstName').value.trim(),
                    lastName: document.getElementById('prof-lastName').value.trim(),
                    company: document.getElementById('prof-company').value.trim(),
                    companySize: document.getElementById('prof-companySize').value,
                    phone: document.getElementById('prof-phone').value.trim(),
                    address: document.getElementById('prof-address').value.trim(),
                    city: document.getElementById('prof-city').value.trim(),
                    postalCode: document.getElementById('prof-postalCode').value.trim(),
                    country: document.getElementById('prof-country').value.trim(),
                };

                clientData = await api('/api/client/me', 'PUT', body);
                updateSidebarUser();
                showToast(t('portal.infoUpdated','Information updated successfully'));
            } catch (err) {
                showToast(err.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = t('portal.saveChanges','Save Changes');
            }
        }

        // =============================================
        // PAGE: Change password
        // =============================================
        function renderPassword(container) {
            container.innerHTML = `
                <div class="fade-in">
                    <div class="mb-6">
                        <h2 class="text-xl font-bold text-gray-900">${t('portal.changePassword','Change Password')}</h2>
                        <p class="text-sm text-gray-500 mt-0.5">${t('portal.changePasswordDesc','Update your password to keep your account secure')}</p>
                    </div>
                    <div class="bg-white rounded-xl border border-gray-200 p-6 max-w-lg">
                        <form onsubmit="handleChangePassword(event)" class="space-y-5">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1.5">${t('portal.currentPassword','Current password')}</label>
                                <input type="password" id="pw-current" required
                                    class="input-focus w-full px-4 py-2.5 border border-gray-300 rounded-lg text-sm text-gray-900 outline-none transition-all">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1.5">${t('portal.newPassword','New password')}</label>
                                <input type="password" id="pw-new" required placeholder="Min. 8 characters"
                                    class="input-focus w-full px-4 py-2.5 border border-gray-300 rounded-lg text-sm text-gray-900 outline-none transition-all">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1.5">${t('portal.confirmNewPassword','Confirm new password')}</label>
                                <input type="password" id="pw-confirm" required
                                    class="input-focus w-full px-4 py-2.5 border border-gray-300 rounded-lg text-sm text-gray-900 outline-none transition-all">
                            </div>
                            <button type="submit" id="btn-change-pw"
                                class="px-6 py-2.5 bg-rainbow-500 hover:bg-rainbow-600 text-white font-semibold rounded-lg text-sm transition-colors disabled:opacity-60 disabled:cursor-not-allowed">
                                ${t('portal.changePassword','Change Password')}
                            </button>
                        </form>
                    </div>
                </div>
            `;
        }

        async function handleChangePassword(e) {
            e.preventDefault();
            const currentPassword = document.getElementById('pw-current').value;
            const newPassword = document.getElementById('pw-new').value;
            const confirmPassword = document.getElementById('pw-confirm').value;

            if (newPassword.length < 8) {
                showToast(t('portal.passwordMin8','New password must be at least 8 characters.'), 'error');
                return;
            }
            if (newPassword !== confirmPassword) {
                showToast(t('portal.passwordsNoMatch','Passwords do not match.'), 'error');
                return;
            }

            const btn = document.getElementById('btn-change-pw');
            btn.disabled = true;
            btn.textContent = t('portal.updating','Updating...');

            try {
                await api('/api/client/change-password', 'POST', { currentPassword, newPassword, confirmPassword });
                showToast(t('portal.passwordChanged','Password changed successfully'));
                document.getElementById('pw-current').value = '';
                document.getElementById('pw-new').value = '';
                document.getElementById('pw-confirm').value = '';
            } catch (err) {
                showToast(err.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = t('portal.changePassword','Change Password');
            }
        }

        // =============================================
        // PAGE: Payment methods
        // =============================================
        async function renderPayment(container) {
            container.innerHTML = `
                <div class="fade-in">
                    <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-6 gap-3">
                        <div>
                            <h2 class="text-xl font-bold text-gray-900">${t('portal.paymentMethods','Payment Methods')}</h2>
                            <p class="text-sm text-gray-500 mt-0.5">${t('portal.manageBankCards','Manage your bank cards')}</p>
                        </div>
                        <button onclick="openAddCardModal()" class="inline-flex items-center gap-2 px-4 py-2.5 bg-rainbow-500 hover:bg-rainbow-600 text-white text-sm font-semibold rounded-lg transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"/></svg>
                            ${t('portal.addCard','Add a Card')}
                        </button>
                    </div>
                    <div id="cards-list" class="space-y-3">
                        <div class="bg-white rounded-xl border border-gray-200 p-6 animate-pulse">
                            <div class="h-5 bg-gray-200 rounded w-1/3 mb-3"></div>
                            <div class="h-4 bg-gray-200 rounded w-1/2"></div>
                        </div>
                    </div>
                </div>
            `;

            try {
                const methods = await api('/api/client/payment-methods');
                const listEl = document.getElementById('cards-list');
                const cards = methods.data || methods || [];

                if (cards.length === 0) {
                    listEl.innerHTML = `
                        <div class="bg-white rounded-xl border border-gray-200 p-12 text-center">
                            <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h3m-3.75 3h15a2.25 2.25 0 002.25-2.25V6.75A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25v10.5A2.25 2.25 0 004.5 19.5z"/></svg>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-1">No cards on file</h3>
                            <p class="text-gray-500 text-sm mb-4">Add a bank card for your payments.</p>
                            <button onclick="openAddCardModal()" class="inline-flex items-center gap-2 px-4 py-2 bg-rainbow-500 hover:bg-rainbow-600 text-white text-sm font-semibold rounded-lg transition-colors">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"/></svg>
                                Add a Card
                            </button>
                        </div>
                    `;
                    return;
                }

                listEl.innerHTML = cards.map(card => {
                    const c = card.card || card;
                    const brand = (c.brand || 'carte').charAt(0).toUpperCase() + (c.brand || 'carte').slice(1);
                    const isDefault = card.isDefault || card.is_default;
                    return `
                        <div class="bg-white rounded-xl border ${isDefault ? 'border-rainbow-300 ring-1 ring-rainbow-100' : 'border-gray-200'} p-5 flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-8 bg-gray-100 rounded flex items-center justify-center text-xs font-bold text-gray-500 uppercase">${c.brand || '?'}</div>
                                <div>
                                    <p class="text-sm font-medium text-gray-900">${brand} **** ${c.last4 || '????'}</p>
                                    <p class="text-xs text-gray-500">Expire ${String(c.exp_month || c.expMonth || '??').padStart(2, '0')}/${c.exp_year || c.expYear || '??'}</p>
                                </div>
                                ${isDefault ? '<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-rainbow-100 text-rainbow-700">Default</span>' : ''}
                            </div>
                            <div class="flex items-center gap-2">
                                ${!isDefault ? `
                                    <button onclick="setDefaultCard('${card.id}')" class="px-3 py-1.5 text-xs font-medium text-gray-600 hover:bg-gray-100 border border-gray-200 rounded-lg transition-colors">
                                        Set as default
                                    </button>
                                ` : ''}
                                <button onclick="deleteCard('${card.id}')" class="px-3 py-1.5 text-xs font-medium text-red-600 hover:bg-red-50 border border-red-200 rounded-lg transition-colors">
                                    Delete
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (err) {
                document.getElementById('cards-list').innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-xl p-4 text-sm text-red-700">Error: ${err.message}</div>
                `;
            }
        }

        // =============================================
        // Add card (Stripe Elements)
        // =============================================
        async function openAddCardModal() {
            openModal('modal-add-card');
            document.getElementById('card-errors').classList.add('hidden');

            try {
                // Get setup intent client secret
                const { clientSecret, publishableKey } = await api('/api/client/payment-methods/setup-intent', 'POST');

                if (!stripe) {
                    stripe = Stripe(publishableKey);
                }

                const elements = stripe.elements({ clientSecret });

                // Unmount any previous card element
                if (cardElement) {
                    cardElement.unmount();
                }

                cardElement = elements.create('card', {
                    style: {
                        base: {
                            fontSize: '14px',
                            color: '#1F2937',
                            fontFamily: 'Inter, sans-serif',
                            '::placeholder': { color: '#9CA3AF' },
                        },
                        invalid: { color: '#EF4444' },
                    }
                });
                cardElement.mount('#card-element');

                // Store for confirmation
                window._stripeElements = elements;
                window._clientSecret = clientSecret;

            } catch (err) {
                const errEl = document.getElementById('card-errors');
                errEl.textContent = err.message;
                errEl.classList.remove('hidden');
            }
        }

        async function handleAddCard() {
            const btn = document.getElementById('btn-add-card');
            btn.disabled = true;
            btn.textContent = 'Processing...';
            document.getElementById('card-errors').classList.add('hidden');

            try {
                const { error, setupIntent } = await stripe.confirmCardSetup(
                    window._clientSecret,
                    {
                        payment_method: {
                            card: cardElement,
                        }
                    }
                );

                if (error) {
                    throw new Error(error.message);
                }

                closeModal('modal-add-card');
                showToast(t('portal.cardAdded','Card added successfully'));
                navigateTo('payment');
            } catch (err) {
                const errEl = document.getElementById('card-errors');
                errEl.textContent = err.message;
                errEl.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Add Card';
            }
        }

        async function setDefaultCard(paymentMethodId) {
            try {
                await api(`/api/client/payment-methods/${paymentMethodId}/default`, 'POST');
                showToast(t('portal.defaultCardUpdated','Default card updated'));
                navigateTo('payment');
            } catch (err) {
                showToast(err.message, 'error');
            }
        }

        async function deleteCard(paymentMethodId) {
            if (!confirm('Delete this card?')) return;
            try {
                await api(`/api/client/payment-methods/${paymentMethodId}`, 'DELETE');
                showToast(t('portal.cardDeleted','Card deleted'));
                navigateTo('payment');
            } catch (err) {
                showToast(err.message, 'error');
            }
        }

        // =============================================
        // PAGE: Invoices
        // =============================================
        async function renderInvoices(container) {
            container.innerHTML = `
                <div class="fade-in">
                    <div class="mb-6">
                        <h2 class="text-xl font-bold text-gray-900">${t('portal.invoices','Invoices')}</h2>
                        <p class="text-sm text-gray-500 mt-0.5">${t('portal.invoicesDesc','View and download your invoices')}</p>
                    </div>
                    <div class="bg-white rounded-xl border border-gray-200 overflow-hidden" id="invoices-container">
                        <div class="p-6 animate-pulse">
                            <div class="h-5 bg-gray-200 rounded w-1/3 mb-3"></div>
                            <div class="h-4 bg-gray-200 rounded w-full mb-2"></div>
                            <div class="h-4 bg-gray-200 rounded w-2/3"></div>
                        </div>
                    </div>
                </div>
            `;

            try {
                const invoices = await api('/api/client/invoices');
                const ic = document.getElementById('invoices-container');
                const list = invoices.data || invoices || [];

                if (list.length === 0) {
                    ic.innerHTML = `
                        <div class="p-12 text-center">
                            <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"/></svg>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-1">No Invoices</h3>
                            <p class="text-gray-500 text-sm">Your invoices will appear here once generated.</p>
                        </div>
                    `;
                    return;
                }

                const invoiceStatusBadge = (status) => {
                    const map = {
                        paid: { label: 'Paid', class: 'bg-green-100 text-green-700' },
                        open: { label: 'Pending', class: 'bg-yellow-100 text-yellow-700' },
                        draft: { label: 'Draft', class: 'bg-gray-100 text-gray-600' },
                        void: { label: 'Canceled', class: 'bg-red-100 text-red-700' },
                        uncollectible: { label: 'Uncollectible', class: 'bg-red-100 text-red-700' },
                    };
                    const s = map[status] || { label: status, class: 'bg-gray-100 text-gray-600' };
                    return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${s.class}">${s.label}</span>`;
                };

                ic.innerHTML = `
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50 text-gray-500 text-xs uppercase tracking-wider">
                                <tr>
                                    <th class="text-left py-3 px-5 font-medium">Number</th>
                                    <th class="text-left py-3 px-5 font-medium">Date</th>
                                    <th class="text-left py-3 px-5 font-medium">Amount</th>
                                    <th class="text-left py-3 px-5 font-medium">Status</th>
                                    <th class="text-right py-3 px-5 font-medium">Action</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                ${list.map(inv => `
                                    <tr class="hover:bg-gray-50 transition-colors">
                                        <td class="py-3.5 px-5 font-medium text-gray-900">${inv.number || inv.id || '-'}</td>
                                        <td class="py-3.5 px-5 text-gray-600">${formatDate(inv.date || inv.created)}</td>
                                        <td class="py-3.5 px-5 text-gray-900 font-medium">${inv.amount != null ? formatPrice(inv.amount) : (inv.total != null ? formatPrice(inv.total) : '-')}</td>
                                        <td class="py-3.5 px-5">${invoiceStatusBadge(inv.status)}</td>
                                        <td class="py-3.5 px-5 text-right">
                                            ${inv.invoicePdf || inv.invoice_pdf || inv.pdf ? `
                                                <a href="${inv.invoicePdf || inv.invoice_pdf || inv.pdf}" target="_blank"
                                                    class="inline-flex items-center gap-1.5 text-rainbow-600 hover:text-rainbow-700 text-xs font-medium">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3"/></svg>
                                                    PDF
                                                </a>
                                            ` : '-'}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (err) {
                document.getElementById('invoices-container').innerHTML = `
                    <div class="p-4 text-red-600 text-sm">Error: ${err.message}</div>
                `;
            }
        }

        // =============================================
        // Update sidebar user info
        // =============================================
        function updateSidebarUser() {
            if (!clientData) return;
            const name = [clientData.firstName, clientData.lastName].filter(Boolean).join(' ') || 'User';
            const initials = (clientData.firstName?.[0] || '') + (clientData.lastName?.[0] || '');
            document.getElementById('sidebar-username').textContent = name;
            document.getElementById('sidebar-email').textContent = clientData.email || '';
            document.getElementById('sidebar-avatar').textContent = initials.toUpperCase() || '--';
            document.getElementById('header-name').textContent = name;
        }

        // =============================================
        // Init
        // =============================================
        async function init() {
            try {
                clientData = await api('/api/client/me');
                updateSidebarUser();
            } catch (err) {
                console.error('Failed to load user:', err);
            }

            // Check for plan params from homepage flow
            const urlParams = new URLSearchParams(window.location.search);
            const planFromUrl = urlParams.get('plan');
            const licensesFromUrl = urlParams.get('licenses');

            if (planFromUrl) {
                // Clean URL without reloading
                window.history.replaceState({}, '', '/portal');
                // Auto-create subscription — user already chose plan on offers page
                navigateTo('subscriptions');
                try {
                    const plans = await fetchPlans();
                    const match = plans.find(p =>
                        p.name.toLowerCase().replace(/\s+/g, '-') === planFromUrl.toLowerCase() ||
                        p.name.toLowerCase() === planFromUrl.toLowerCase() ||
                        (p.id && p.id === planFromUrl)
                    );
                    if (match) {
                        const lc = parseInt(licensesFromUrl) || 1;
                        // Check company first
                        if (!clientData) clientData = await api('/api/client/me');
                        if (!clientData.company || !clientData.company.trim()) {
                            _pendingSubPlanId = match.id;
                            _pendingSubLicenseCount = lc;
                            openModal('modal-company');
                            document.getElementById('company-prompt-input').focus();
                        } else {
                            await doCreateSubscription(match.id, lc);
                        }
                    } else {
                        await openNewSubscriptionModal(planFromUrl, licensesFromUrl);
                    }
                } catch (err) {
                    showToast(err.message, 'error');
                    await openNewSubscriptionModal(planFromUrl, licensesFromUrl);
                }
            } else {
                renderPage('dashboard');
            }
        }

        init();
    </script>
</body>
</html>
